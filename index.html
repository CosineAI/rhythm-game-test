<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Piano Smasher</title>
  <meta name="application-name" content="Piano Smasher">
  <meta name="apple-mobile-web-app-title" content="Piano Smasher">
  <meta name="description" content="Tap lanes or keys to smash notes to your music. Upload a song, auto-generate a chart, and play.">
  <meta name="theme-color" content="#0b0e16">
  <meta property="og:title" content="Piano Smasher">
  <meta property="og:description" content="Tap lanes or keys to smash notes to your music. Upload a song, auto-generate a chart, and play.">
  <meta property="og:type" content="website">
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
  <main>
    <div class="game">
      <header class="topbar">
        <h1>Piano Smasher</h1>
        <div class="status" id="status">Tap “New Song” to choose a track.</div>
      </header>

      <div class="controls">
        <button id="newSongBtn" class="btn primary">New Song</button>
        <button id="pauseBtn" class="btn">Pause</button>
        <button id="playBtn" class="btn">Play</button>
        <button id="restartBtn" class="btn">Restart</button>
        <button id="openSettingsBtn" class="btn">Settings</button>
      </div>

      <audio id="audioPlayer" preload="auto"></audio>

      <div class="playfield" id="playfield">
        <div class="lanes" id="lanes">
          <div class="lane white" data-key="z"></div>
          <div class="lane black" data-key="s"></div>
          <div class="lane white" data-key="x"></div>
          <div class="lane black" data-key="d"></div>
          <div class="lane white" data-key="c"></div>
        </div>

        <div class="gridlines" id="gridlines"></div>

        <div class="hit-line" id="hitLine"></div>
        <div class="hit-fire" id="hitFire"></div>

        <div class="keycaps" id="keycaps">
          <div class="keycap white" data-key="z"><span>Z</span></div>
          <div class="keycap black" data-key="s"><span>S</span></div>
          <div class="keycap white" data-key="x"><span>X</span></div>
          <div class="keycap black" data-key="d"><span>D</span></div>
          <div class="keycap white" data-key="c"><span>C</span></div>
        </div>

        <div class="judgement" id="judgement"></div>

        <div class="combo" id="combo">
          <div class="label">COMBO</div>
          <div class="value">0</div>
        </div>

        <div class="combo-toast" id="comboToast"></div>
      </div>

      <div class="scoreboard" id="scoreboard">
        <div class="score-label">Score</div>
        <div class="score-value" id="scoreValue">0</div>
      </div>

      <footer class="instructions">
        <p>Controls: White keys Z X C, Black keys S D.</p>
      </footer>
    </div>
  </main>
  <footer>
    <p>&copy; 2025 Your Name</p>
  </footer>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal hidden" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="modal-backdrop" data-close="1"></div>
    <div class="modal-panel" role="document">
      <header class="modal-header">
        <h2 id="settingsTitle">Settings</h2>
      </header>
      <div class="modal-body">
        <div class="form-row">
          <label for="settingsDifficulty">Difficulty</label>
          <select id="settingsDifficulty" class="select">
            <option value="veryeasy">Very Easy</option>
            <option value="easy">Easy</option>
            <option value="normal">Normal</option>
            <option value="hard">Hard</option>
          </select>
        </div>

        <div class="form-row">
          <label for="inputLag">Input offset (ms)</label>
          <div class="range-row">
            <input type="range" id="inputLag" min="-300" max="300" step="5">
            <input type="number" id="inputLagNumber" class="number" min="-300" max="300" step="1">
          </div>
          <small class="muted">Use this if your hits feel late/early. Positive delays the hit window; negative makes it earlier.</small>
        </div>

        <div class="form-row">
          <label for="chartPad">Chart padding (ms)</label>
          <div class="range-row">
            <input type="range" id="chartPad" min="0" max="10000" step="100">
            <input type="number" id="chartPadNumber" class="number" min="0" max="10000" step="10">
          </div>
          <small class="muted">No notes will be placed in the first/last N ms of the track when generating a chart.</small>
        </div>

        <div class="form-row">
          <label>Rebind keys</label>
          <div class="keybinds">
            <input type="text" id="keyBind0" class="keybind" maxlength="1" placeholder="Z">
            <input type="text" id="keyBind1" class="keybind" maxlength="1" placeholder="S">
            <input type="text" id="keyBind2" class="keybind" maxlength="1" placeholder="X">
            <input type="text" id="keyBind3" class="keybind" maxlength="1" placeholder="D">
            <input type="text" id="keyBind4" class="keybind" maxlength="1" placeholder="C">
          </div>
          <small class="muted">Choose any five keys (one character each). Leftmost is the left lane.</small>
        </div>

        <div class="form-row">
          <label for="fallSpeed">Fall speed (x)</label>
          <div class="range-row">
            <input type="range" id="fallSpeed" min="0.5" max="2.0" step="0.05">
            <input type="number" id="fallSpeedNumber" class="number" min="0.5" max="2.0" step="0.01">
          </div>
          <small class="muted">Controls how fast notes fall. 1.00x is the current default.</small>
        </div>

        <div class="form-row">
          <label><input type="checkbox" id="showGridlines"> Show beat gridlines (experimental)</label>
          <small class="muted">Requires a precomputed chart. Tries to estimate BPM and render beat guides.</small>
        </div>
      </div>
      <footer class="modal-footer">
        <button id="settingsCancel" class="btn">Cancel</button>
        <button id="settingsSave" class="btn primary">Save</button>
      </footer>
    </div>
  </div>

  <!-- Results Modal -->
  <div id="resultsModal" class="modal hidden" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="resultsTitle">
    <div class="modal-backdrop" data-close="1"></div>
    <div class="modal-panel" role="document">
      <header class="modal-header">
        <h2 id="resultsTitle">Results</h2>
      </header>
      <div class="modal-body results-body">
        <div class="results-grid">
          <div class="result-row">
            <span class="result-label perfect">Perfect</span>
            <span class="result-value" id="resultPerfect">0</span>
          </div>
          <div class="result-row">
            <span class="result-label good">Good</span>
            <span class="result-value" id="resultGood">0</span>
          </div>
          <div class="result-row">
            <span class="result-label okay">Okay</span>
            <span class="result-value" id="resultOkay">0</span>
          </div>
          <div class="result-row">
            <span class="result-label bad">Bad</span>
            <span class="result-value" id="resultBad">0</span>
          </div>
          <div class="result-sep"></div>
          <div class="result-row">
            <span class="result-label">Max Combo</span>
            <span class="result-value" id="resultMaxCombo">0</span>
          </div>
          <div class="result-row">
            <span class="result-label">Total Score</span>
            <span class="result-value big" id="resultTotalScore">0</span>
          </div>
        </div>
      </div>
      <footer class="modal-footer">
        <button id="resultsNewSong" class="btn">Play New Song</button>
        <button id="resultsReplay" class="btn primary">Replay</button>
      </footer>
    </div>
  </div>

  <!-- Setup / Start Modal -->
  <div id="setupModal" class="modal" aria-hidden="false" role="dialog" aria-modal="true" aria-labelledby="setupTitle">
    <div class="modal-backdrop" data-close="1"></div>
    <div class="modal-panel setup" role="document">
      <header class="modal-header">
        <h2 id="setupTitle">Get Ready</h2>
        <small class="muted">Pick a song, set difficulty, generate a chart, then start.</small>
      </header>
      <div class="modal-body setup-body">
        <div class="form-row">
          <label>Choose MP3/WAV</label>
          <label class="file-upload wide">
            <input type="file" id="setupFile" accept="audio/*">
            <span id="setupFileLabel">Select audio file…</span>
          </label>
          <div id="setupSongName" class="song-name" title=""></div>
          <small class="muted">We’ll analyze your song to create a note chart.</small>
        </div>
        <div class="form-row two-col">
          <div class="col">
            <label for="setupDifficulty">Difficulty</label>
            <select id="setupDifficulty" class="select">
              <option value="veryeasy">Very Easy</option>
              <option value="easy">Easy</option>
              <option value="normal" selected>Normal</option>
              <option value="hard">Hard</option>
            </select>
          </div>
          <div class="col">
            <label for="setupGenMethod">Generation Method</label>
            <select id="setupGenMethod" class="select">
              <option value="classic" selected>Classic</option>
              <option value="chord_v15">Chord-focused v1.5</option>
            </select>
            <small class="muted">Classic: onset-based. v1.5: chord-guided arpeggios and voicings.</small>
          </div>
        </div>
        <div class="form-row">
          <button id="setupGenerate" class="btn primary wide">Generate Chart</button>
        </div>
      </div>
      <footer class="modal-footer">
        <button id="setupOpenSettings" class="btn">Settings</button>
        <button id="setupStart" class="btn primary" disabled>Start</button>
      </footer>
    </div>
  </div>

  <script src="assets/js/rg.js"></script>
  <script src="assets/js/constants.js"></script>
  <script src="assets/js/difficulty.js"></script>
  <script src="assets/js/dom.js"></script>
  <script src="assets/js/settings.js"></script>
  <script src="assets/js/state.js"></script>
  <script src="assets/js/freq.js"></script>
  <script src="assets/js/algo.js"></script>
  <script src="assets/js/audio.js"></script>
  <script src="assets/js/chart.js"></script>
  <script src="assets/js/chords.js"></script>
  <script src="assets/js/notes.js"></script>
  <script src="assets/js/ui.js"></script>
  <script src="assets/js/grid.js"></script>
  <script src="assets/js/fullscreen.js"></script>
  <script src="assets/js/score.js"></script>
  <script src="assets/js/analysis.js"></script>
  <script src="assets/js/game.js"></script>
  <script src="assets/js/input.js"></script>
  <script src="assets/js/main.js"></script>
  <script src="assets/js/setup.js"></script>